<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚˜ì˜ AI í—ˆë¸Œ (ë¡œê·¸ì¸)</title>
    <style>
        /* (ìŠ¤íƒ€ì¼ ì½”ë“œëŠ” ì´ì „ê³¼ ê±°ì˜ ë™ì¼í•©ë‹ˆë‹¤) */
        body { background-color: #f0f2f5; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding-top: 50px; }
        .card { background-color: #ffffff; padding: 40px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); text-align: center; width: 500px; margin-bottom: 20px; }
        h1 { color: #1a73e8; }
        textarea { width: 100%; height: 100px; margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background-color: #1a73e8; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; font-size: 16px; margin-left: 5px; }
        button:hover { background-color: #1558b0; }
        #memoListContainer { margin-top: 10px; width: 500px; }
        ul { list-style: none; padding: 0; margin: 0; }
        li {
            background-color: #ffffff; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); margin-bottom: 15px;
            text-align: left; border-left: 5px solid #1a73e8;
            position: relative; padding-right: 150px;
        }
        li small { color: #888; font-size: 12px; display: block; margin-top: 8px; }
        li p.summary { background-color: #f0f2f5; padding: 10px; margin-top: 15px; margin-bottom: 5px; border-radius: 5px; font-style: italic; color: #333; }
        .listButton { border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; position: absolute; top: 20px; }
        .deleteButton { background-color: #e74c3c; color: white; right: 20px; }
        .deleteButton:hover { background-color: #c0392b; }
        .editButton { background-color: #3498db; color: white; right: 80px; }
        .editButton:hover { background-color: #2980b9; }
        #authContainer { width: 500px; text-align: right; margin-bottom: 10px; }
        #googleLoginButton { background-color: #4285F4; }
        #kakaoLoginButton { background-color: #FEE500; color: #191919; font-weight: bold; }
        #logoutButton { background-color: #aaa; padding: 10px 20px; font-size: 14px; }
        #userProfile { font-weight: bold; color: #333; margin-right: 10px; }
        .hidden { display: none; }

        /* [S4-Final-UX] '1íšŒìš© ì½”ë“œ' ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        #kakaoLinkCard { background-color: #FEE500; }
        #kakaoLinkCard p { color: #191919; font-size: 14px; }
        
        /* [S4-Final-UX] 'ì½”ë“œ'ì™€ 'ë³µì‚¬' ë²„íŠ¼ì„ ë¬¶ëŠ” ì»¨í…Œì´ë„ˆ */
        #linkCodeContainer {
            display: flex; /* (í•µì‹¬) 'ê°€ë¡œ'ë¡œ ë°°ì¹˜ */
            align-items: center; /* (í•µì‹¬) 'ì„¸ë¡œ' ì¤‘ì•™ ì •ë ¬ */
            justify-content: center;
            margin: 10px 0;
            width: 100%;
        }
        
        #linkCodeDisplay { 
            font-size: 18px; font-weight: bold; color: #1a73e8; 
            background-color: #fff; padding: 10px; border-radius: 5px; 
            letter-spacing: 0;
            user-select: all;
            flex-grow: 1; /* [ì¶”ê°€!] 'ë‚¨ì€ ê³µê°„'ì„ ê½‰ ì±„ì›€ */
            text-align: center;
        }
        
        /* [S4-Final-UX] 'ì—°ê²°ì½”ë“œ ë³µì‚¬í•˜ê¸°' ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ìœ„ì¹˜ ì´ë™) */
        #copyCodeButton {
            background-color: #3498db; /* íŒŒë€ìƒ‰ */
            color: white;
            font-size: 14px;
            padding: 12px 15px; /* (íŒ¨ë”© ì¡°ì •) */
            margin-left: 10px; /* (ì™¼ìª½ ê°„ê²©) */
        }
        #copyCodeButton:hover { background-color: #2980b9; }

        /* [S4-Final-UX] 'ì¹´í†¡ ì—´ê¸°' ë²„íŠ¼ (ê¸°ì¡´ ë²„íŠ¼ ì¬í™œìš©) */
        #openKakaoButton {
            background-color: #191919; /* ê²€ì€ìƒ‰ */
            color: white;
            font-size: 16px;
            margin-top: 10px; /* (ìœ„ìª½ ê°„ê²©) */
        }
        #openKakaoButton:hover { background-color: #333; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

    <div id="authContainer">
        <span id="userProfile" class="hidden"></span>
        <button id="googleLoginButton">Google ë¡œê·¸ì¸</button>
        <button id="kakaoLoginButton">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</button>
        <button id="logoutButton" class="hidden">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="mainApp" class="hidden">
        
        <div id="kakaoLinkCard" class="card">
            <h4>ì¹´ì¹´ì˜¤í†¡ ê³„ì • ì—°ê²° (1íšŒ í•„ìˆ˜)</h4>
            <p>ì¹´í†¡ìœ¼ë¡œ ë³´ë‚¸ ë©”ëª¨ë¥¼ 'ë‚´ ê³„ì •'ì— ì €ì¥í•˜ë ¤ë©´, 1íšŒìš© ì½”ë“œë¥¼ ë°œê¸‰ë°›ì•„ ì¹´í†¡ ì±—ë´‡ì—ê²Œ ë³´ë‚´ì£¼ì„¸ìš”.</p>
            
            <button id="generateLinkCodeButton">1íšŒìš© ì½”ë“œ ë°œê¸‰ë°›ê¸°</button>
            
            <div id="linkCodeContainer" class="hidden">
                <div id="linkCodeDisplay"></div>
                <button id="copyCodeButton">ì—°ê²°ì½”ë“œ ë³µì‚¬í•˜ê¸°</button>
            </div>
            
            <button id="openKakaoButton" class="hidden">ì¹´ì¹´ì˜¤í†¡ ì±„íŒ…ë°© ì—´ê¸°</button>
            
            <small id="linkCodeHelp" class="hidden">('ëª…ë ¹ì–´'ë¥¼ 'ë³µì‚¬'í•œ í›„, 'ì¹´í†¡ë°©'ì„ ì—´ì–´ 'ë¶™ì—¬ë„£ê¸°' í•˜ì„¸ìš”!)</small>
        </div>
        <div class="card">
            <h1>ë‚˜ì˜ AI í—ˆë¸Œ ğŸ§ </h1>
            <textarea id="memoInput" placeholder="ì—¬ê¸°ì— ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (AIê°€ ìš”ì•½í•´ ë“œë¦½ë‹ˆë‹¤!)"></textarea>
            <button id="saveButton">AI ìš”ì•½í•˜ë©° ì „ì†¡!</button>
            <p id="statusText" style="margin-top: 15px;"></p>
        </div>

        <div id="memoListContainer">
            <ul id="memoList"></ul>
        </div>
    </div>

    <script>
        // [Firebase ì—´ì‡ ] (ì‚¬ì¥ë‹˜ ì½”ë“œë¥¼ 'ì •í™•í•˜ê²Œ' ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”!)
        const firebaseConfig = {
            apiKey: "AIzaSyBeDDDOYsbbjVBG7aHlBrhxnl7uQ23k4lM",
            authDomain: "ai-hub-project-460a3.firebaseapp.com",
            projectId: "ai-hub-project-460a3",
            storageBucket: "ai-hub-project-460a3.firebasestorage.app",
            messagingSenderId: "224573122791",
            appId: "1:224573122791:web:bdfb559a50de276c519a42"
        };
        // (â†‘â†‘â†‘ ì‚¬ì¥ë‹˜ì˜ 'ì—´ì‡ 'ê°€ ì´ê²ƒê³¼ 'ë‹¤ë¥´ë‹¤ë©´', Firebase ì½˜ì†”ì—ì„œ 'ë‹¤ì‹œ' ë³µì‚¬í•´ì„œ 'êµì²´'í•´ì£¼ì„¸ìš”!)

        // [S4-Final-BugFix] 'ì¹´ì¹´ì˜¤ ì±„ë„ ID'
        const KAKAO_CHANNEL_ID = "_ZjxiHn"; // (ì‚¬ì¥ë‹˜ì˜ 'ì†Œë¬¸ì j' ì±„ë„ ID)
        
        // Firebase ì•± ì´ˆê¸°í™” (ë™ì¼)
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore(); 
        
        // --- ì „ì—­ ë³€ìˆ˜ (ë™ì¼) ---
        let currentUser = null; 
        let unsubscribeListener = null;

        // --- HTML ìš”ì†Œë“¤ (S4-Final-UX) ---
        const googleLoginButton = document.getElementById('googleLoginButton');
        const kakaoLoginButton = document.getElementById('kakaoLoginButton');
        const logoutButton = document.getElementById('logoutButton');
        const userProfile = document.getElementById('userProfile');
        const mainApp = document.getElementById('mainApp');
        const saveButton = document.getElementById('saveButton');
        const memoInput = document.getElementById('memoInput');
        const statusText = document.getElementById('statusText');
        const memoList = document.getElementById('memoList');
        const generateLinkCodeButton = document.getElementById('generateLinkCodeButton');
        const linkCodeContainer = document.getElementById('linkCodeContainer'); // [S4-Final-UX ì¶”ê°€!]
        const linkCodeDisplay = document.getElementById('linkCodeDisplay');
        const linkCodeHelp = document.getElementById('linkCodeHelp');
        const copyCodeButton = document.getElementById('copyCodeButton'); 
        const openKakaoButton = document.getElementById('openKakaoButton'); 

        // --- 'ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€' (ë²„ê·¸ ìˆ˜ì •!) ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user; 
                console.log("ë¡œê·¸ì¸ ì„±ê³µ!", currentUser.displayName, currentUser.uid);
                
                if (currentUser.displayName) {
                    userProfile.textContent = `${currentUser.displayName}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
                } else {
                    userProfile.textContent = `ì†ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`; 
                }
                
                userProfile.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                googleLoginButton.classList.add('hidden');
                kakaoLoginButton.classList.add('hidden');
                mainApp.classList.remove('hidden');
                setupRealtimeListener(currentUser.uid); 
            } else {
                currentUser = null;
                console.log("ë¡œê·¸ì•„ì›ƒ ìƒíƒœ");
                userProfile.classList.add('hidden');
                logoutButton.classList.add('hidden');
                googleLoginButton.classList.remove('hidden');
                kakaoLoginButton.classList.remove('hidden');
                mainApp.classList.add('hidden');
                memoList.innerHTML = ''; 
                if (unsubscribeListener) {
                    unsubscribeListener();
                    console.log("ì‹¤ì‹œê°„ ê°ì‹œ ì¤‘ì§€.");
                }
            }
        });

        // --- 'ë¡œê·¸ì¸ ë²„íŠ¼' ì„¹ì…˜ (S4-Final-BugFix-V3) ---
        
        // [Google ë¡œê·¸ì¸] (ë™ì¼)
        googleLoginButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => { console.error("Google ë¡œê·¸ì¸ ì‹¤íŒ¨:", error); });
        });

        // [ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸] (ë‹‰ë„¤ì„ ìˆ˜ë™ ì—…ë°ì´íŠ¸)
        kakaoLoginButton.addEventListener('click', () => {
            const provider = new firebase.auth.OAuthProvider('oidc.kakao');
            provider.addScope('profile_nickname'); 
            provider.setCustomParameters({ prompt: 'consent' }); 

            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    const profile = result.additionalUserInfo.profile;
                    
                    console.log("Kakao ë¡œê·¸ì¸ ì„±ê³µ. profile ê°ì²´:", profile); 

                    let kakaoNickname = null;
                    if (profile && profile.properties && profile.properties.nickname) {
                        kakaoNickname = profile.properties.nickname; 
                    } else if (profile && profile.nickname) {
                        kakaoNickname = profile.nickname; 
                    } else if (profile && profile.name) {
                        kakaoNickname = profile.name; 
                    }

                    if ((!user.displayName || user.displayName === 'ì†ë‹˜') && kakaoNickname) {
                        console.log(`Firebase 'displayName'ì´ ë¹„ì–´ìˆì–´ '${kakaoNickname}'(ìœ¼)ë¡œ ìˆ˜ë™ ì—…ë°ì´íŠ¸ë¥¼ ì‹œë„í•©ë‹ˆë‹¤...`);
                        user.updateProfile({
                            displayName: kakaoNickname
                        }).then(() => {
                            console.log("í”„ë¡œí•„ ì´ë¦„ ìˆ˜ë™ ì—…ë°ì´íŠ¸ ì„±ê³µ!");
                            location.reload(); 
                        });
                    } else {
                         console.log("Kakao ë¡œê·¸ì¸ ì„±ê³µ! (ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš”)", user.displayName); 
                         console.log("ì°¾ì€ ë‹‰ë„¤ì„:", kakaoNickname);
                         if (!user.displayName) location.reload();
                    }
                })
                .catch((error) => { 
                    console.error("Kakao ë¡œê·¸ì¸ ì‹¤íŒ¨:", error); 
                });
        });

        // [ë¡œê·¸ì•„ì›ƒ] (ë™ì¼)
        logoutButton.addEventListener('click', () => { auth.signOut(); });

        // --- 'ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ' í•¨ìˆ˜ (S2 - ë™ì¼) ---
        const setupRealtimeListener = (uid) => {
            // ... (ì´ì „ S2 ì½”ë“œì™€ 100% ë™ì¼í•©ë‹ˆë‹¤) ...
            console.log(`'${uid}' ì‚¬ìš©ìì˜ ë©”ëª¨ ê°ì‹œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`);
            const query = db.collection('memos').where('uid', '==', uid).orderBy('createdAt', 'desc');
            unsubscribeListener = query.onSnapshot((snapshot) => {
                console.log("ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°ì§€!", snapshot.docs.length, "ê°œ");
                memoList.innerHTML = ''; 
                snapshot.forEach(doc => {
                    const memoItem = { id: doc.id, data: doc.data() }; 
                    const li = document.createElement('li');
                    const date = new Date(memoItem.data.createdAt.seconds * 1000).toLocaleString('ko-KR'); 
                    li.innerHTML = `
                        <button class="listButton editButton" data-id="${memoItem.id}" data-text="${memoItem.data.text}">ìˆ˜ì •</button>
                        <button class="listButton deleteButton" data-id="${memoItem.id}">ì‚­ì œ</button>
                        ${memoItem.data.text}
                        <p class="summary">ğŸ¤– AI ìš”ì•½: ${memoItem.data.summary}</p>
                        <small>${date}</small>
                    `;
                    memoList.appendChild(li);
                });
            }, (error) => { console.error("ğŸ”¥ ì‹¤ì‹œê°„ ê°ì‹œ ì‹¤íŒ¨:", error); });
        };

        // --- C.R.U.D. ë²„íŠ¼ ê¸°ëŠ¥ (S1 - 'ì˜¤íƒ€' ìˆ˜ì •ëœ ìµœì¢…ë³¸) ---
        
        // [ì €ì¥ ë²„íŠ¼]
        saveButton.addEventListener('click', async () => {
            // ... (ì´ì „ê³¼ 100% ë™ì¼) ...
            if (!currentUser) return;
            const token = await currentUser.getIdToken();
            const memo = memoInput.value;
            saveButton.disabled = true;
            statusText.innerHTML = "ğŸ¤– AIê°€ ë©”ëª¨ë¥¼ ìš”ì•½ ì¤‘ì…ë‹ˆë‹¤...";
            const response = await fetch('/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ memo: memo }),
            });
            const data = await response.json();
            if (response.ok) {
                statusText.innerHTML = "âœ… " + data.message;
                memoInput.value = "";
            } else { 
                statusText.innerHTML = "âŒ " + data.message;
            }
            saveButton.disabled = false;
        });

        // [ëª©ë¡(ìˆ˜ì •/ì‚­ì œ) í´ë¦­]
        memoList.addEventListener('click', async (event) => {
            // ... (ì´ì „ê³¼ 100% ë™ì¼) ...
            if (!currentUser) return;
            const token = await currentUser.getIdToken();
            if (event.target.classList.contains('deleteButton')) {
                if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { return; }
                const memoId = event.target.dataset.id;
                await fetch(`/api/memos/${memoId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            }
            if (event.target.classList.contains('editButton')) {
                const memoId = event.target.dataset.id;
                const currentText = event.target.dataset.text;
                const newText = prompt("ë©”ëª¨ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”:", currentText);
                if (newText && newText !== currentText) {
                    await fetch(`/api/memos/${memoId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ text: newText }) 
                    });
                }
            }
        });
        
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ [â­ 'ê³¼ì œ 2' (UX ìµœì¢… ê°œì„ ) 'ë””ìì¸' ìˆ˜ì •!] ğŸ‘‡ğŸ‘‡ğŸ‘‡
        generateLinkCodeButton.addEventListener('click', async () => {
            if (!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            const token = await currentUser.getIdToken();
            
            console.log("ì„œë²„ì— 1íšŒìš© ì½”ë“œ ìš”ì²­ ì¤‘...");
            generateLinkCodeButton.disabled = true;
            linkCodeDisplay.textContent = "ì½”ë“œ ìƒì„± ì¤‘...";
            linkCodeContainer.classList.remove('hidden'); // [ìˆ˜ì •!] ì»¨í…Œì´ë„ˆë¥¼ ë³´ì—¬ì¤Œ

            try {
                // 'ì„œë²„'ì— '1íšŒìš© ì½”ë“œ'ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤ (ë™ì¼)
                const response = await fetch('/api/generate-link-code', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) { throw new Error('ì„œë²„ì—ì„œ ì½”ë“œ ìƒì„± ì‹¤íŒ¨'); }
                const data = await response.json(); // { code: "123456" }
                
                // [â­ 1. 'ëª…ë ¹ì–´' ì™„ì„±!]
                const command = `/ì—°ê²° ${data.code}`;
                
                // [â­ 2. 'UI' ë³€ê²½!]
                linkCodeDisplay.textContent = command; // 'ëª…ë ¹ì–´'ë¥¼ 'ë³´ì—¬ì¤ë‹ˆë‹¤'.
                linkCodeHelp.textContent = "('ì—°ê²°ì½”ë“œ'ë¥¼ 'ë³µì‚¬'í•œ í›„, 'ì¹´í†¡ë°©'ì„ ì—´ì–´ 'ë¶™ì—¬ë„£ê¸°' í•˜ì„¸ìš”!)";
                linkCodeHelp.classList.remove('hidden');
                
                // [â­ 3. 'ë²„íŠ¼'ë“¤ í™œì„±í™”!]
                copyCodeButton.classList.remove('hidden');
                openKakaoButton.classList.remove('hidden');
                generateLinkCodeButton.textContent = "ì½”ë“œ ì¬ë°œê¸‰"; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½

            } catch (error) {
                console.error("1íšŒìš© ì½”ë“œ ë°œê¸‰ ì‹¤íŒ¨:", error);
                linkCodeDisplay.textContent = "ì—ëŸ¬! ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
            } finally {
                generateLinkCodeButton.disabled = false; // 'ì¬ë°œê¸‰' ë²„íŠ¼ìœ¼ë¡œ í™œì„±í™”
            }
        });

        // [S4-Final-UX ì¶”ê°€!] 'ì—°ê²°ì½”ë“œ ë³µì‚¬' ë²„íŠ¼ í´ë¦­
        copyCodeButton.addEventListener('click', async () => {
            const commandToCopy = linkCodeDisplay.textContent;
            if (!commandToCopy || commandToCopy.includes('...')) {
                return; // ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì¤‘ë‹¨
            }
            try {
                // 'ì‚¬ìš©ì'ê°€ 'ì§ì ‘' í´ë¦­í–ˆê¸° ë•Œë¬¸ì—, 'í´ë¦½ë³´ë“œ' ë³µì‚¬ê°€ 'í—ˆìš©'ë©ë‹ˆë‹¤!
                await navigator.clipboard.writeText(commandToCopy);
                alert("âœ… ì—°ê²°ì½”ë“œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n[ì¹´ì¹´ì˜¤í†¡ ì±„íŒ…ë°© ì—´ê¸°]ë¥¼ ëˆŒëŸ¬ 'ë¶™ì—¬ë„£ê¸°' í•˜ì„¸ìš”.");
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert("âŒ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
            }
        });

        // [S4-Final-UX ì¶”ê°€!] 'ì¹´í†¡ë°© ì—´ê¸°' ë²„íŠ¼ í´ë¦­
        openKakaoButton.addEventListener('click', () => {
            window.open(`http://pf.kakao.com/${KAKAO_CHANNEL_ID}/chat`, '_blank');
        });

    </script>
</body>
</html>